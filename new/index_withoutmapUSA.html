<!DOCTYPE html>
<html lang="de">

<head>
	<title>DWD- Warnmodul 2</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="dj0001">
	<link rel="icon" type="image/png" sizes="192x192" href="icons/warn.png">

</head>
<body>
<div id="anzeige"></div>

<script>
var area=location.search.slice(1)||prompt("enter coordinates (0 = \u2316)","48.4,10.9")||0  //URL parameter ?48.37,10.9 (small view)
if(area==0) navigator.geolocation.getCurrentPosition(function(e){getFeatureInfo([e.coords.latitude,e.coords.longitude])},function(e){getFeatureInfo(0)});
else getFeatureInfo(area.split(","))

function getFeatureInfo(ort) {
var lat=1*ort[0]||48.4, lon=1*ort[1]||10.9  //edit here
console.log(lat+","+lon)
var url = lon<0? "https://api.weather.gov/alerts/active?point="+lat+","+lon :  //USA
"https://maps.dwd.de/geoserver/dwd/wms/?request=GetFeatureInfo&service=WMS&srs=EPSG%3A4326&styles=&transparent=true&version=1.1.1&format=image%2Fpng&bbox="+lon+"%2C"+lat+"%2C"+(1*lon+0.001)+"%2C"+(1*lat+0.001)+"&height=1&width=1&layers=Warnungen_Gemeinden_vereinigt&query_layers=Warnungen_Gemeinden_vereinigt&info_format=application%2Fjson&propertyName=EVENT%2CONSET%2CEXPIRES%2CSENT%2CSEVERITY%2CEC_GROUP%2CSENT&FEATURE_COUNT=50&x=0&y=0"

    var xhr = new XMLHttpRequest()
    xhr.open("GET", url, true)
    xhr.onload = function() {var data=JSON.parse(this.response); showGetFeatureInfo(data); setTimeout(function(){getFeatureInfo(ort)}, 300000) }
    xhr.send()
}

function showGetFeatureInfo(data) { var content="", opt={day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}
var severity=["no warnings","Minor","Moderate","Severe","Extreme"], max=0
if(data.features) data.features.forEach(function(item){ item=item.properties
max=Math.max(max,severity.indexOf(item.severity||item.SEVERITY))
content += "<p>"+(item.EVENT||item.event)
+"<br>"+new Date(item.ONSET||item.onset).toLocaleString(data.title?'en-US':'de',opt)  //+" Uhr"
+"<br>"+new Date(item.EXPIRES||item.expires).toLocaleString(data.title?'en-US':'de',opt)  //+" Uhr"
+ "</p>"
})

var small=true; small=location.search && small  //edit here false
var wl=1; if(max<wl) max=0  //Minor warnlevel edit here
if(small) content=severity[max]  //small view
document.querySelector("#anzeige").innerHTML=(small?'':"<h2>Official warning</h2>")+(content||"no warnings")+" <a href='https://www.dwd.de/warnungen'>dwd.de</a>" +" <a href='https://www.weather.gov'>NWS</a>"
//fetch('http://localhost:8000/api/newdeveloper/sensors/3/state',{method:"PUT",body:'{"status":'+max+'}',headers:{'Content-Type':'application/json'}})  //philipshue
}
</script>

</body>
</html>
