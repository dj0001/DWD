<!DOCTYPE html>
<html lang="de">

<head>
	<title>DWD- Warnmodul 2</title>
	<meta charset="utf-8" />
	<meta name="description" content="weather alerts from DWD and NOAA">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="dj0001">
	<link rel="icon" type="image/png" sizes="192x192" href="icons/warn.png">
</head>
<body>
<div id="anzeige">Official warning</div>

<script>
var qs=location.search.slice(1), color=[120,60,30,0,330]
if(qs==1) { qs=""  // ?1 enable philipshue
 var bridge="http://localhost:8000/api/newdeveloper"  //edit here https://localhost:443/api/newdeveloper
 bridge=prompt("change bridge adress\n"+bridge,(localStorage||{}).bridge||bridge)||bridge
 if(!bridge.match('/')) fetch("https://www.meethue.com/api/nupnp").then(function(response){response.json().then(function(data){if(data[0]) bridge='http://'+data[0].internalipaddress+'/api/'+bridge})})  //olddeveloper
 light=prompt("select light","1")||"1"; localStorage.bridge=bridge }  // "/3" sensor

var area=qs||prompt("enter coordinates or location (0 = \u2316)",(localStorage||{}).point||"48.4,10.9")||0  //URL parameter ?48.37,10.9 (small view)
if(area==0||area==1) locate(); 
else if(area.match(/^[\d,-\.]+$/)) getFeatureInfo(area.split(","))
else if(area.match(/^[A-Z]{2}(\d|$)/)) getFeatureInfo2()  //IT013
else fetch("https://nominatim.openstreetmap.org/search?q=" + area + "&format=json&limit=1&addressdetails=1")
 .then(function(response) {response.json().then(function(data) {getFeatureInfo([data[0].lat,data[0].lon],data[0].address.country_code) })})
localStorage.point=area

function locate(){navigator.geolocation.getCurrentPosition(function(e){getFeatureInfo([e.coords.latitude,e.coords.longitude])},function(e){getFeatureInfo(0)})}

function getFeatureInfo2() {
fetch('https://api.rss2json.com/v1/api.json?rss_url=https://meteoalarm.eu/documents/rss/'+area.slice(0,2).toLowerCase()+(area[2]?'/'+area:'')+'.rss')
 .then(function(response) {response.json().then(function(data) {  //setTimeout(function(){getFeatureInfo2()}, 300000)
var dsc=data.items[0].description; document.querySelector("#anzeige").innerHTML=data.feed.title+'<br>'+dsc; hue(dsc.match(/level:(\d)/)[1]-1)}) })
}

function getFeatureInfo(ort,cc) {
var lat=1*ort[0]||48.4, lon=1*ort[1]||10.9  //edit here
console.log(lat+","+lon)
if(!cc && lon>-10 && (lon<5.8||lon>15||lat<47.2||lat>55)) {document.querySelector("#anzeige").innerHTML='enter meteoalarm region (IT013)'; return 0}  //
if(!cc) {cc=lon<0?'us':'de'}  //or do a reverse search
var urls={us:"https://api.weather.gov/alerts/active?point="+lat+","+lon,
 de:"https://maps.dwd.de/geoserver/dwd/wms/?request=GetFeatureInfo&service=WMS&srs=EPSG%3A4326&styles=&transparent=true&version=1.1.1&format=image%2Fpng&bbox="+lon+"%2C"+lat+"%2C"+(1*lon+0.001)+"%2C"+(1*lat+0.001)+"&height=1&width=1&layers=Warnungen_Gemeinden_vereinigt&query_layers=Warnungen_Gemeinden_vereinigt&info_format=application%2Fjson&propertyName=EVENT%2CONSET%2CEXPIRES%2CSENT%2CSEVERITY%2CEC_GROUP&FEATURE_COUNT=50&x=0&y=0"}
var url=urls[cc]; if(!url) {area=cc; getFeatureInfo2(); return 0}

 var xhr = new XMLHttpRequest()
 xhr.open("GET", url, true)
 xhr.onload = function() {var data=JSON.parse(this.response); showGetFeatureInfo(data); setTimeout(function(){area==1?locate():getFeatureInfo(ort,cc)}, 300000) }  //1 watch-geo
 xhr.send()
}

function showGetFeatureInfo(data) { var content="", opt={day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}
var severity=["no warnings","Minor","Moderate","Severe","Extreme"], max=0
if(data.features) data.features.forEach(function(item){ item=item.properties
var mx=severity.indexOf(item.severity||item.SEVERITY); max=Math.max(max,mx)
var o=new Date(item.ONSET||item.onset),     os=(o.getTime()-Date.now())/86.4e4  //24h
var e=new Date(item.EXPIRES||item.expires), es=(e.getTime()-Date.now())/86.4e4, col="hsl("+color[mx]+",100%,50%)"
content += "<p>"+(item.EVENT||item.event)
 +"<br>"+o.toLocaleString(data.title?'en-US':'de',opt)  //+" Uhr"
 +"<br><span style='background:linear-gradient(to right, #80ff80,#80ff80 "+os+"%,"+col+" "+os+"%,"+col+" "+es+"%,#80ff80 "+es+"%)'>"+e.toLocaleString(data.title?'en-US':'de',opt)+"</span>"
 + "</p>"
}); else content+="out of bounds"

var small=true; small=location.search && small  //edit here false
var wl=1; if(max<wl) max=0  //Minor warnlevel edit here
if(small) content="<a href='https://dj0001.github.io/DWD-Warnmodul-2/?ort="+area+"' target='map' style='color:hsl("+color[max]+",100%,50%); text-decoration:none'>&#x25b3; </a>"+ severity[max]  //small view
document.querySelector("#anzeige").innerHTML=(small?'':area+"<h2>Official warning</h2>")+(content||"no warnings")+" <a href='https://www.dwd.de/warnungen'>dwd.de</a>" +" <a href='https://www.weather.gov'>NWS</a>"
hue(max)
}

function hue(max) {if(location.search.slice(1)==1) fetch(bridge+'/'+(isNaN(light)?'sensors':'lights/')+light+'/state',{method:"PUT",body:isNaN(light)?'{"status":'+max+'}':'{"hue":'+182*color[max]+'}',headers:{'Content-Type':'application/json'}})}
</script>

</body>
</html>
